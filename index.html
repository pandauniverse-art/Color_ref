<script>
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const previewImg = document.getElementById('previewImg');
        const paletteArea = document.getElementById('paletteArea');
        const ambientBg = document.getElementById('ambient-bg');
        const urlInput = document.getElementById('urlInput');
        const dropMsg = document.querySelector('.drop-msg');
        const colorThief = new ColorThief();

        // [핵심 1] 붙여넣기(Ctrl+V) 이벤트 - 가장 확실한 방법
        document.addEventListener('paste', (e) => {
            const items = e.clipboardData.items;
            let foundImage = false;
            
            for (let item of items) {
                if (item.type.indexOf('image') !== -1) {
                    const blob = item.getAsFile();
                    processFile(blob);
                    foundImage = true;
                    
                    // UI 효과
                    dropZone.classList.add('active');
                    setTimeout(() => dropZone.classList.remove('active'), 200);
                    break;
                }
            }
            
            // 이미지가 아닌 텍스트(URL 등)를 붙여넣었을 때 처리
            if (!foundImage) {
                 // 텍스트가 붙여넣기 된 경우 URL 입력창으로 포커스 이동 시도 가능
                 // 여기서는 사용자가 헷갈리지 않게 조용히 넘어갑니다.
            }
        });

        // 드래그 앤 드롭 및 클릭
        dropZone.addEventListener('click', () => fileInput.click());
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault(); dropZone.classList.add('dragover');
        });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault(); dropZone.classList.remove('dragover');
            if (e.dataTransfer.files[0]) processFile(e.dataTransfer.files[0]);
        });
        fileInput.addEventListener('change', (e) => {
            if (e.target.files[0]) processFile(e.target.files[0]);
        });

        // 파일 처리 로직
        function processFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                previewImg.src = e.target.result;
                previewImg.style.display = 'block';
                dropMsg.style.display = 'none';
                previewImg.onload = () => extractAndRenderColors();
            }
            reader.readAsDataURL(file);
        }

        // [핵심 2] URL 로딩 로직 개선 (에러 핸들링 강화)
        function loadImageFromUrl() {
            let url = urlInput.value.trim();
            if(!url) return;

            // 1. 간단한 유효성 검사: URL이 아닌 것 같은 텍스트 차단
            if (!url.startsWith('http')) {
                alert("올바른 인터넷 주소(http://...)가 아닙니다.");
                return;
            }

            // 2. 이미지 확장자 체크 (경고용)
            // 사이트 주소를 넣었을 때 미리 알려줌
            const isImage = /\.(jpg|jpeg|png|webp|gif|bmp|svg)/i.test(url);
            
            // 프록시 서버 사용 (이미지 로딩 우회)
            // 'api.allorigins.win'이 가장 안정적임
            const proxyUrl = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(url);
            
            previewImg.crossOrigin = "Anonymous";
            previewImg.src = proxyUrl;
            
            // 로딩 시작 시 UI 변경
            const btn = document.querySelector('.url-input-box .btn');
            const originalBtnText = btn.innerText;
            btn.innerText = "Loading...";
            
            previewImg.onload = () => {
                previewImg.style.display = 'block';
                dropMsg.style.display = 'none';
                extractAndRenderColors();
                btn.innerText = originalBtnText; // 버튼 복구
            };

            previewImg.onerror = () => {
                btn.innerText = originalBtnText; // 버튼 복구
                
                // 에러 메시지 분기 처리
                if (!isImage) {
                    alert("실패: 이미지 주소가 아니라 '웹사이트 주소'를 넣으신 것 같습니다.\n\n해결법: 이미지 위에서 우클릭 -> '이미지 주소 복사'를 선택해서 넣어주세요.");
                } else {
                    alert("실패: 이 사이트(핀터레스트 등)는 보안상 외부 링크를 막고 있습니다.\n\n해결법: 이미지를 '복사(Ctrl+C)'해서 화면에 '붙여넣기(Ctrl+V)' 해주세요! 그게 제일 빠릅니다.");
                }
                
                dropMsg.style.display = 'block';
                previewImg.style.display = 'none';
            };
        }

        // 색상 추출 및 렌더링
        function extractAndRenderColors() {
            try {
                // 색상 추출 시도
                const colors = colorThief.getPalette(previewImg, 5);
                
                // 간혹 이미지가 로드되었으나 색상 추출에 실패하는 경우 방지
                if (!colors) return;

                const mainColor = colors[0];
                ambientBg.style.background = `radial-gradient(circle at 50% 50%, rgb(${mainColor[0]},${mainColor[1]},${mainColor[2]}), #000)`;

                paletteArea.innerHTML = '';
                const hexArray = [];

                colors.forEach((color, index) => {
                    const hex = rgbToHex(color[0], color[1], color[2]);
                    hexArray.push(hex);

                    const wrapper = document.createElement('div');
                    wrapper.className = 'color-item';
                    wrapper.style.animationDelay = `${index * 0.1}s`;

                    const sphere = document.createElement('div');
                    sphere.className = 'sphere';
                    sphere.style.backgroundColor = `rgb(${color[0]}, ${color[1]}, ${color[2]})`;
                    sphere.onclick = () => copyToClipboard(hex);

                    const text = document.createElement('span');
                    text.className = 'hex-code';
                    text.innerText = hex;
                    text.onclick = () => copyToClipboard(hex);

                    wrapper.appendChild(sphere);
                    wrapper.appendChild(text);
                    paletteArea.appendChild(wrapper);
                });

                updateRefLinks(hexArray);

            } catch (e) {
                console.error("Color Extraction Failed:", e);
                // CORS 문제로 캔버스 오염 시 발생하는 에러 처리
                alert("브라우저 보안 문제로 색상을 추출할 수 없습니다.\n이미지를 다운로드해서 업로드하거나, 캡처해서 붙여넣기(Ctrl+V) 해주세요.");
            }
        }

        function updateRefLinks(hexList) {
            const refContainer = document.getElementById('refLinks');
            const pinterestBtn = document.getElementById('btnPinterest');
            const behanceBtn = document.getElementById('btnBehance');
            const googleBtn = document.getElementById('btnGoogle');

            const queryColor = `${hexList[0]} ${hexList[1]}`; 
            
            pinterestBtn.href = `https://www.pinterest.co.kr/search/pins/?q=color palette ${queryColor.replace(/#/g, '')}`;
            behanceBtn.href = `https://www.behance.net/search/projects?search=color palette ${hexList[0].replace(/#/g, '')}`;
            googleBtn.href = `https://www.google.com/search?tbm=isch&q=color palette ${queryColor}`;

            refContainer.classList.add('visible');
        }

        function rgbToHex(r, g, b) {
            return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1).toUpperCase();
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                const toast = document.getElementById('toast');
                toast.innerText = `${text} Copied!`;
                toast.classList.add('show');
                setTimeout(() => toast.classList.remove('show'), 2000);
            });
        }
    </script>
